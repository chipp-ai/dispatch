name: Release Test Suite

on:
  pull_request:
    branches: [main]

jobs:
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest

    services:
      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: chipp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DENO_NO_PACKAGE_JSON: "1"
      DATABASE_URL: postgresql://test:test@localhost:5432/chipp_test
      TEST_DATABASE_URL: postgresql://test:test@localhost:5432/chipp_test
      STRIPE_SANDBOX_KEY: ${{ secrets.STRIPE_SANDBOX_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Setup Database
        run: |
          PGPASSWORD=test psql -h localhost -U test -d chipp_test -f db/test-schema.sql

      - name: Type Check
        run: deno check main.ts

      - name: Run All Tests
        run: |
          deno test --allow-all --no-check --env \
            --ignore=src/__tests__/scenarios/ \
            2>&1
        timeout-minutes: 10

      - name: Run Scenario Tests (LLM + E2E)
        if: env.STRIPE_SANDBOX_KEY != ''
        run: |
          deno test --allow-all --no-check --env \
            src/__tests__/scenarios/ \
            2>&1
        timeout-minutes: 15

  svelte-build:
    name: Svelte Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Type Check
        working-directory: web
        run: npm run check

      - name: Build
        working-directory: web
        run: npm run build

  release-ready:
    name: Release Ready
    runs-on: ubuntu-latest
    needs: [full-test-suite, svelte-build]
    steps:
      - name: All checks passed
        run: echo "Release ready"
