# Promtail Helm values -- DaemonSet scraping pod logs
# Chart: grafana/promtail

config:
  clients:
    - url: http://loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push

  snippets:
    pipelineStages:
      # Strip CRI prefix (timestamp + stdout/stderr + flags) from all log lines
      - cri: {}
      # Then process chipp-deno pods with NDJSON logs
      - match:
          selector: '{app="chipp-deno"}'
          stages:
            # Parse the NDJSON line to extract level
            - json:
                expressions:
                  level: level
                  ts_field: ts
            # Promote level to a stream label (4 values: debug/info/warn/error)
            - labels:
                level:
            # Use the app's timestamp instead of scrape time
            - timestamp:
                source: ts_field
                format: RFC3339Nano
                fallback_formats:
                  - RFC3339
            # Drop the intermediate ts_field from labels
            - labeldrop:
                - ts_field

resources:
  requests:
    cpu: 250m
    memory: 512Mi
  limits:
    cpu: 500m
    memory: 512Mi

tolerations:
  - effect: NoSchedule
    operator: Exists
  - effect: NoExecute
    operator: Exists

# GKE Autopilot only allows /var/log/ hostPath in read-only mode
# Use emptyDir for positions file instead of hostPath
defaultVolumes:
  - name: run
    emptyDir: {}
  - name: pods
    hostPath:
      path: /var/log/pods

defaultVolumeMounts:
  - name: run
    mountPath: /run/promtail
  - name: pods
    mountPath: /var/log/pods
    readOnly: true

# Autopilot-compatible: no docker/containers path needed, GKE logs go to /var/log/pods
extraArgs:
  - -config.expand-env=true
