# Cloudflare Worker Scripts

## Overview

This directory contains scripts for managing the Cloudflare Worker that serves the chipp-deno consumer SPA.

## Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                     LOCAL DEVELOPMENT                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   Browser (localhost:8788)                                          │
│        │                                                             │
│        ▼                                                             │
│   ┌─────────────────────┐                                           │
│   │ Cloudflare Worker   │  ◄── Serves SPA from R2                   │
│   │ (wrangler dev)      │      Injects window.__APP_BRAND__         │
│   │ port: 8788          │      Proxies /api/* to Deno               │
│   └─────────┬───────────┘                                           │
│             │                                                        │
│   ┌─────────┴───────────┐      ┌─────────────────────┐             │
│   │                     │      │                     │             │
│   ▼                     ▼      │                     │             │
│   R2 Bucket          Deno API  │   Vite Dev Server   │             │
│   (--remote)         port:8000 │   port: 5173        │             │
│                                │   (HMR, no brand)   │             │
│   chipp-deno-spa-dev           │                     │             │
│   ├── index.html               └─────────────────────┘             │
│   ├── assets/                                                       │
│   └── brands/{slug}/config.json                                     │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## Scripts

### `dev.sh` - Full Worker Development

Builds SPA, uploads to R2, and starts Worker with real R2 connection.

```bash
./scripts/dev.sh                  # Full: build + upload + run
./scripts/dev.sh --skip-build     # Use existing build
./scripts/dev.sh --skip-upload    # Use existing R2 assets
./scripts/dev.sh --worker-only    # Just start Worker (fastest)
```

**When to use:** Testing brand injection, PWA features, or production-like serving.

### `upload-assets.sh` - Upload SPA to R2

Uploads built SPA assets to R2 bucket.

```bash
./scripts/upload-assets.sh        # Upload to dev bucket
./scripts/upload-assets.sh --prod # Upload to production (with confirmation)
```

**Prerequisite:** Build the SPA first: `cd ../web && npm run build`

## Development Workflow

### Normal Development (Recommended)

Use the main dev script which starts everything:

```bash
cd apps/chipp-deno
./scripts/dev.sh
```

This starts:

- Deno API on :8000
- Vite dev server on :5173
- Cloudflare Worker on :8788

Access http://localhost:8788 for brand injection testing.

### Worker-Only Development

If API and Vite are already running:

```bash
cd cloudflare-worker
./scripts/dev.sh --worker-only
```

### After SPA Changes

When you modify the Svelte SPA and want to test through the Worker:

```bash
cd apps/chipp-deno/web
npm run build
cd ../cloudflare-worker
./scripts/upload-assets.sh
```

The Worker will immediately serve the new assets from R2.

## Key Concepts

### Brand Injection

The Worker reads `brands/{slug}/config.json` from R2 and injects:

```javascript
window.__APP_BRAND__ = {
  slug: "my-app",
  name: "My App",
  color: "#FF5500",
  bg: "#0a0a0a",
  logo: "https://api.chipp.ai/consumer/my-app/pwa/icon/192",
};
```

This enables instant branded splash screens without waiting for API calls.

### R2 Buckets

- **chipp-deno-spa-dev**: Development/testing
- **chipp-deno-spa**: Production

The `--remote` flag in wrangler connects to real R2.
Without it, Miniflare simulates an empty bucket.

### Brand Config Sync

Brand configs are auto-synced to R2 when apps are created/updated.
See `src/services/brand-sync.service.ts`.

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

- Updated dev.sh with --worker-only flag and better documentation
- Fixed upload-assets.sh to support content types and dev/prod buckets
- Documented full development workflow with brand injection
  </claude-mem-context>
